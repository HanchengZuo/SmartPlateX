<!DOCTYPE html>
<html lang="zh">

<!-- ç³»ç»Ÿæ ‡é¢˜ -->
<header style="text-align: center; margin: 10px 0 10px;">
    <h1 style="margin: 0; font-size: 28px;">æ™ºèƒ½è½¦ç‰Œè¯†åˆ«ä¸ç»Ÿè®¡ç³»ç»Ÿ</h1>
    <p style="color: #666; font-size: 14px;">Smart License Plate Recognition & Analytics System | v1.0.0</p>
</header>

<head>
    <meta charset="UTF-8">
    <title>è½¦ç‰Œè¯†åˆ«ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <!-- å¼•å…¥ Chart.js å’Œä¸»è„šæœ¬ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</head>

<body>

    <!-- ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ è§†é¢‘ -->
    <div class="section" id="step1">
        <h2>ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ è§†é¢‘</h2>
        <form action="/upload" method="post" enctype="multipart/form-data">
            <input type="file" name="video" accept="video/*" required>
            <button type="submit">ä¸Šä¼ </button>
        </form>
    </div>

    <!-- ç¬¬äºŒæ­¥ï¼šè§†é¢‘åº“ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰ -->
    <div class="section" id="step2">
        <h2>ç¬¬äºŒæ­¥ï¼šè§†é¢‘åº“ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰</h2>

        <!-- ç¬¬äºŒæ­¥ï¼šé€‰æ‹©å¾…å¤„ç†è§†é¢‘ -->
        <form method="get" action="/">
            <label for="selected">é€‰æ‹©å¾…å¤„ç†è§†é¢‘ï¼š</label>
            <select name="selected" id="selected" required>
                <option value="" {% if not selected_filename %}selected{% endif %}>-- è¯·é€‰æ‹© --</option>
                {% for video in videos %}
                <option value="{{ video.name }}">{{ video.original_filename }} | {{ video.name }} | {{ video.duration }}
                    ç§’</option>
                {% endfor %}
            </select>
            <button type="submit">ç¡®å®š</button>
        </form>


        {% if selected_filename %}
        <p style="margin-top:10px; color: #555;">ğŸ¯ å½“å‰å¾…å¤„ç†è§†é¢‘ï¼š<strong>{{ selected_filename }}</strong></p>
        {% endif %}

        <!-- è§†é¢‘åˆ—è¡¨ä»ç„¶ä¿ç•™ -->
        {% if videos %}
        <ul>
            {% for video in videos %}
            <li>
                <strong>åŸæ–‡ä»¶åï¼š</strong>{{ video.original_name }}<br>
                <strong>ç³»ç»Ÿæ–‡ä»¶åï¼š</strong>{{ video.name }}<br>
                <strong>ä¸Šä¼ æ—¶é—´ï¼š</strong>{{ video.created_time | datetimeformat }}<br>
                <strong>è§†é¢‘æ—¶é•¿ï¼š</strong>{{ video.duration }} ç§’ -
                <a href="{{ video.url }}" target="_blank">é¢„è§ˆ</a>
            </li>
            <hr>
            {% endfor %}
        </ul>
        {% else %}
        <p>æš‚æ— è§†é¢‘</p>
        {% endif %}


        <!-- è§†é¢‘åˆ†é¡µ -->
        {% if video_total_pages > 1 %}
        <div class="pagination">
            {% for p in range(1, video_total_pages + 1) %}
            {% if p == video_page %}
            <strong>[{{ p }}]</strong>
            {% else %}
            <a href="{{ url_for('index', video_page=p) }}#step2">[{{ p }}]</a>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>



    <!-- ç¬¬ä¸‰æ­¥ï¼šé€‰æ‹©è§†é¢‘æŠ½å¸§ -->
    {% if selected_video_id %}
    <div class="section" id="step3">
        <h2>ç¬¬ä¸‰æ­¥ï¼šæŠ½å¸§ï¼ˆå½“å‰è§†é¢‘ï¼š{{ selected_video_id }}ï¼‰</h2>
        <form method="post" action="/extract" onsubmit="showLoading()">
            <input type="hidden" name="video_path" value="{{ selected_video_id }}.mp4">
            <label>å¸§ç‡ï¼ˆfpsï¼‰ï¼š</label>
            <input type="number" name="fps" value="1" min="1" required>
            <p class="note">æç¤ºï¼šfps è¡¨ç¤ºæ¯ç§’æŠ½å–çš„å¸§æ•°ï¼Œ1 fps = æ¯ç§’æŠ½ 1 å¸§ï¼Œ5 fps = æ¯ç§’æŠ½ 5 å¸§ã€‚</p>
            <br>
            <button type="submit">å¼€å§‹æŠ½å¸§</button>
        </form>
    </div>
    {% endif %}

    <div id="loading" style="display: none; text-align: center; padding: 10px;">
        <p style="font-weight: bold; color: #666;">æ­£åœ¨æŠ½å¸§ï¼Œè¯·ç¨å€™â€¦â€¦</p>
        <pre id="progress-log"
            style="padding: 10px; background: #f0f0f0; height: 180px; overflow-y: auto; font-size: 12px;"></pre>
        <!-- <img src="{{ url_for('static', filename='loading.gif') }}" width="60" alt="åŠ è½½ä¸­"> -->
    </div>


    <!-- ç¬¬å››æ­¥ï¼šå¸§å›¾åº“ -->
    {% if selected_video_id %}
    <div class="section" id="step4">
        <h2>ç¬¬å››æ­¥ï¼šå¸§å›¾åº“ï¼ˆå½“å‰è§†é¢‘ï¼š{{ selected_video_id }}ï¼‰</h2>

        <!-- è§†é¢‘é€‰æ‹© + åˆ·æ–°æŒ‰é’® -->
        <form method="get" action="/#step4">
            <input type="hidden" name="video_id" value="{{ selected_video_id }}">
            <button type="submit">åˆ·æ–°å¸§å›¾åˆ—è¡¨</button>
        </form>

        <!-- æ˜¾ç¤ºå¸§å›¾ï¼ˆåˆ†é¡µéƒ¨åˆ†ï¼‰ -->
        {% if frames %}
        <div class="frame-grid">
            {% for img in frames %}
            <div class="frame-item">
                <a href="{{ img.url }}" target="_blank">{{ img.name }}</a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>æš‚æ— å¸§å›¾ç‰‡</p>
        {% endif %}

        <!-- åˆ†é¡µæ§ä»¶ -->
        {% if total_pages > 1 %}
        <div class="pagination">
            {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <strong>[{{ p }}]</strong>
            {% else %}
            <a href="{{ url_for('index', video_id=selected_video_id, page=p) }}#step4">[{{ p }}]</a>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- ç¬¬äº”æ­¥ï¼šè½¦ç‰Œè¯†åˆ« -->
    {% if selected_video_id %}
    <div class="section" id="step5">
        <h2>ç¬¬äº”æ­¥ï¼šè°ƒç”¨ç™¾åº¦äº‘è½¦ç‰Œè¯†åˆ«ï¼ˆå½“å‰è§†é¢‘ï¼š{{ selected_video_id }}ï¼‰</h2>

        <form action="/recognize" method="post" onsubmit="startRecognitionProgress()">
            <input type="hidden" name="video_id" value="{{ selected_video_id }}">
            <button type="submit">å¼€å§‹è¯†åˆ«</button>
        </form>

        <div id="recognition-status" style="display:none; margin-top: 10px;">
            <p id="recognition-text" style="color: #555;">è¯†åˆ«ä¸­...</p>
            <progress id="recognition-progress" value="0" max="100" style="width: 100%;"></progress>
        </div>

        <!-- âœ… æ·»åŠ è¯†åˆ«çŠ¶æ€æç¤º -->
        {% if results %}
        <p style="color: green; font-weight: bold;">è¯†åˆ«çŠ¶æ€ï¼šâœ… å·²å®Œæˆ</p>
        {% else %}
        <p style="color: gray;">è¯†åˆ«çŠ¶æ€ï¼šâŒ æœªè¯†åˆ« </p>
        {% endif %}

        <!-- è¯†åˆ«ç»“æœå±•ç¤º... -->
        {% if results %}
        <h3>è¯†åˆ«ç»“æœï¼š</h3>
        <table>
            <thead>
                <tr>
                    <th>å¸§å›¾æ–‡ä»¶å</th>
                    <th>è½¦ç‰Œå·</th>
                    <th>é¢œè‰²</th>
                    <th>ç½®ä¿¡åº¦</th>
                </tr>
            </thead>
            <tbody>
                {% for r in results %}
                <tr>
                    <td>{{ r.frame }}</td>
                    <td>{{ r.plate }}</td>
                    <td>{{ r.color }}</td>
                    <td>{{ r.confidence }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- åŸå§‹è¯†åˆ«ç»“æœï¼ˆè°ƒè¯•ç”¨ï¼‰
        <hr>
        <h3>åŸå§‹è¯†åˆ«ç»“æœ</h3>
        <div style="background:#f5f5f5;padding:10px;border-radius:6px;font-size:13px;max-height:300px;overflow:auto;">
            {% for r in results %}
            <div style="margin-bottom: 15px;">
                <strong>{{ r.frame }}</strong>:
                <pre>{{ r.raw | tojson(indent=2) }}</pre>
            </div>
            {% endfor %}
        </div>
        {% endif %} -->
    </div>
    {% endif %}

    {% if results %}
    <hr>
    <h3>ğŸ¯ å½“å‰è§†é¢‘è¯†åˆ«ç»Ÿè®¡</h3>


    <!-- å¤‡ç”¨æ–‡æœ¬å±•ç¤º -->
    <div class="fallback-stats">
        <h4>ğŸ“ åœ°åŒºåˆ†å¸ƒï¼š</h4>
        <ul>
            {% for region, count in current_region_stats.items() %}
            <li>{{ region }}ï¼š{{ count }} ä¸ª</li>
            {% endfor %}
        </ul>

        <h4>ğŸ¨ é¢œè‰²åˆ†å¸ƒï¼š</h4>
        <ul>
            {% for color, count in current_color_stats.items() %}
            <li>{{ color }}ï¼š{{ count }} ä¸ª</li>
            {% endfor %}
        </ul>
    </div>

    <!-- å›¾è¡¨å®¹å™¨ -->
    <div class="stats-container">
        <canvas id="regionChart" width="400" height="200"></canvas>
        <canvas id="colorChart" width="400" height="200" style="margin-top:30px;"></canvas>
    </div>
    {% endif %}


    <!-- ç¬¬å…­æ­¥ï¼šç»Ÿè®¡åˆ·æ–°æŒ‰é’® -->
    <div class="section" id="step6">
        <form method="get" action="/statistics">
            <button type="submit" class="full-width-btn">ğŸ“Š æŸ¥çœ‹æ‰€æœ‰è§†é¢‘çš„ç»Ÿè®¡ç»“æœ</button>
        </form>
    </div>

    <footer style="text-align:center; margin-top: 50px; color: #777; font-size: 13px;">
        æ™ºèƒ½è½¦ç‰Œè¯†åˆ«ä¸ç»Ÿè®¡ç³»ç»Ÿï¼ˆSmart License Plate Recognition & Analytics Systemï¼‰<br>
        ç‰ˆæœ¬ v1.0.0 | åŸºäº Flask + Chart.js | æ›´æ–°æ—¶é—´ï¼š2025-04-12
    </footer>


</body>

</html>
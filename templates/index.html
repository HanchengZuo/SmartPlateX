<!DOCTYPE html>
<html lang="zh">

<!-- 系统标题 -->
<header style="text-align: center; margin: 10px 0 10px;">
    <h1 style="margin: 0; font-size: 28px;">智能车牌识别与统计系统</h1>
    <p style="color: #666; font-size: 14px;">Smart License Plate Recognition & Analytics System | v1.0.0</p>
</header>

<head>
    <meta charset="UTF-8">
    <title>车牌识别系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <!-- 引入 Chart.js 和主脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
</head>

<body>

    <!-- 第一步：上传视频 -->
    <div class="section" id="step1">
        <h2>第一步：上传视频</h2>
        <form action="/upload" method="post" enctype="multipart/form-data">
            <input type="file" name="video" accept="video/*" required>
            <button type="submit">上传</button>
        </form>
    </div>

    <!-- 第二步：视频库（按时间倒序） -->
    <div class="section" id="step2">
        <h2>第二步：视频库（按时间倒序）</h2>

        <!-- 第二步：选择待处理视频 -->
        <form method="get" action="/">
            <label for="selected">选择待处理视频：</label>
            <select name="selected" id="selected" required>
                <option value="" {% if not selected_filename %}selected{% endif %}>-- 请选择 --</option>
                {% for video in videos %}
                <option value="{{ video.name }}">{{ video.original_filename }} | {{ video.name }} | {{ video.duration }}
                    秒</option>
                {% endfor %}
            </select>
            <button type="submit">确定</button>
        </form>


        {% if selected_filename %}
        <p style="margin-top:10px; color: #555;">🎯 当前待处理视频：<strong>{{ selected_filename }}</strong></p>
        {% endif %}

        <!-- 视频列表仍然保留 -->
        {% if videos %}
        <ul>
            {% for video in videos %}
            <li>
                <strong>原文件名：</strong>{{ video.original_name }}<br>
                <strong>系统文件名：</strong>{{ video.name }}<br>
                <strong>上传时间：</strong>{{ video.created_time | datetimeformat }}<br>
                <strong>视频时长：</strong>{{ video.duration }} 秒 -
                <a href="{{ video.url }}" target="_blank">预览</a>
            </li>
            <hr>
            {% endfor %}
        </ul>
        {% else %}
        <p>暂无视频</p>
        {% endif %}


        <!-- 视频分页 -->
        {% if video_total_pages > 1 %}
        <div class="pagination">
            {% for p in range(1, video_total_pages + 1) %}
            {% if p == video_page %}
            <strong>[{{ p }}]</strong>
            {% else %}
            <a href="{{ url_for('index', video_page=p) }}#step2">[{{ p }}]</a>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>



    <!-- 第三步：选择视频抽帧 -->
    {% if selected_video_id %}
    <div class="section" id="step3">
        <h2>第三步：抽帧（当前视频：{{ selected_video_id }}）</h2>
        <form method="post" action="/extract" onsubmit="showLoading()">
            <input type="hidden" name="video_path" value="{{ selected_video_id }}.mp4">
            <label>帧率（fps）：</label>
            <input type="number" name="fps" value="1" min="1" required>
            <p class="note">提示：fps 表示每秒抽取的帧数，1 fps = 每秒抽 1 帧，5 fps = 每秒抽 5 帧。</p>
            <br>
            <button type="submit">开始抽帧</button>
        </form>
    </div>
    {% endif %}

    <div id="loading" style="display: none; text-align: center; padding: 10px;">
        <p style="font-weight: bold; color: #666;">正在抽帧，请稍候……</p>
        <pre id="progress-log"
            style="padding: 10px; background: #f0f0f0; height: 180px; overflow-y: auto; font-size: 12px;"></pre>
        <!-- <img src="{{ url_for('static', filename='loading.gif') }}" width="60" alt="加载中"> -->
    </div>


    <!-- 第四步：帧图库 -->
    {% if selected_video_id %}
    <div class="section" id="step4">
        <h2>第四步：帧图库（当前视频：{{ selected_video_id }}）</h2>

        <!-- 视频选择 + 刷新按钮 -->
        <form method="get" action="/#step4">
            <input type="hidden" name="video_id" value="{{ selected_video_id }}">
            <button type="submit">刷新帧图列表</button>
        </form>

        <!-- 显示帧图（分页部分） -->
        {% if frames %}
        <div class="frame-grid">
            {% for img in frames %}
            <div class="frame-item">
                <a href="{{ img.url }}" target="_blank">{{ img.name }}</a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>暂无帧图片</p>
        {% endif %}

        <!-- 分页控件 -->
        {% if total_pages > 1 %}
        <div class="pagination">
            {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <strong>[{{ p }}]</strong>
            {% else %}
            <a href="{{ url_for('index', video_id=selected_video_id, page=p) }}#step4">[{{ p }}]</a>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- 第五步：车牌识别 -->
    {% if selected_video_id %}
    <div class="section" id="step5">
        <h2>第五步：调用百度云车牌识别（当前视频：{{ selected_video_id }}）</h2>

        <form action="/recognize" method="post" onsubmit="startRecognitionProgress()">
            <input type="hidden" name="video_id" value="{{ selected_video_id }}">
            <button type="submit">开始识别</button>
        </form>

        <div id="recognition-status" style="display:none; margin-top: 10px;">
            <p id="recognition-text" style="color: #555;">识别中...</p>
            <progress id="recognition-progress" value="0" max="100" style="width: 100%;"></progress>
        </div>

        <!-- ✅ 添加识别状态提示 -->
        {% if results %}
        <p style="color: green; font-weight: bold;">识别状态：✅ 已完成</p>
        {% else %}
        <p style="color: gray;">识别状态：❌ 未识别 </p>
        {% endif %}

        <!-- 识别结果展示... -->
        {% if results %}
        <h3>识别结果：</h3>
        <table>
            <thead>
                <tr>
                    <th>帧图文件名</th>
                    <th>车牌号</th>
                    <th>颜色</th>
                    <th>置信度</th>
                </tr>
            </thead>
            <tbody>
                {% for r in results %}
                <tr>
                    <td>{{ r.frame }}</td>
                    <td>{{ r.plate }}</td>
                    <td>{{ r.color }}</td>
                    <td>{{ r.confidence }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- 原始识别结果（调试用）
        <hr>
        <h3>原始识别结果</h3>
        <div style="background:#f5f5f5;padding:10px;border-radius:6px;font-size:13px;max-height:300px;overflow:auto;">
            {% for r in results %}
            <div style="margin-bottom: 15px;">
                <strong>{{ r.frame }}</strong>:
                <pre>{{ r.raw | tojson(indent=2) }}</pre>
            </div>
            {% endfor %}
        </div>
        {% endif %} -->
    </div>
    {% endif %}

    {% if results %}
    <hr>
    <h3>🎯 当前视频识别统计</h3>


    <!-- 备用文本展示 -->
    <div class="fallback-stats">
        <h4>📍 地区分布：</h4>
        <ul>
            {% for region, count in current_region_stats.items() %}
            <li>{{ region }}：{{ count }} 个</li>
            {% endfor %}
        </ul>

        <h4>🎨 颜色分布：</h4>
        <ul>
            {% for color, count in current_color_stats.items() %}
            <li>{{ color }}：{{ count }} 个</li>
            {% endfor %}
        </ul>
    </div>

    <!-- 图表容器 -->
    <div class="stats-container">
        <canvas id="regionChart" width="400" height="200"></canvas>
        <canvas id="colorChart" width="400" height="200" style="margin-top:30px;"></canvas>
    </div>
    {% endif %}


    <!-- 第六步：统计刷新按钮 -->
    <div class="section" id="step6">
        <form method="get" action="/statistics">
            <button type="submit" class="full-width-btn">📊 查看所有视频的统计结果</button>
        </form>
    </div>

    <footer style="text-align:center; margin-top: 50px; color: #777; font-size: 13px;">
        智能车牌识别与统计系统（Smart License Plate Recognition & Analytics System）<br>
        版本 v1.0.0 | 基于 Flask + Chart.js | 更新时间：2025-04-12
    </footer>


</body>

</html>